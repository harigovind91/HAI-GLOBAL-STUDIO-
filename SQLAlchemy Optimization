from db import SessionLocal
from models import Journal
from sqlalchemy import or_

def profit_and_loss():
    db = SessionLocal()
    try:
        # सिर्फ वही एंट्रीज लाओ जिनमें 'income' या 'expense' शब्द हो
        entries = db.query(Journal).filter(
            or_(Journal.account.ilike('%income%'), Journal.account.ilike('%expense%'))
        ).all()
        
        income = sum(e.credit for e in entries if "income" in e.account.lower())
        expense = sum(e.debit for e in entries if "expense" in e.account.lower())
        
        return {
            "status": "Success",
            "report_type": "P&L",
            "income": round(income, 2),
            "expense": round(expense, 2),
            "net_profit": round(income - expense, 2)
        }
    finally:
        db.close()
